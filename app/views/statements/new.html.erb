
<style>
  fieldset { margin-top: 30px }
  .input-group-addon { padding: 10px 11px !important }
</style>
<div class="row">
<%=form_for @default_statement, html: { class: "direct-upload col-lg-12 form-horizontal" } do |f| %>
  <h2 class="col-lg-12" id="upload_title"><%= "Share Video or Audio" %></h2>
  <div class="col-lg-12">
    <em class="col-lg-12"><%= "By sharing your content with us, you grant us permission to share it with others." %></em>
  <%= f.fields_for :user, @default_statement.user do |u| %>
    <fieldset class="col-lg-12">
      <div class="col-lg-6">
        <%=u.text_field :first_name, class: "form-control", placeholder: "First Name"%>
      </div>
      <div class="col-lg-6">
        <%=u.text_field :last_name, class: "form-control", placeholder: "Last Name"%>
      </div>
      <div class="col-lg-6">
        <%=u.text_field :email, class: "form-control", placeholder: "Email"%>
      </div>
      <div class="col-lg-6">
        <%=u.text_field :postal_code, class: "form-control", placeholder: "ZIP Code"%>
      </div>
    </fieldset>
  <% end %>
  <em class="col-lg-offset-1 col-lg-11">Want to remain anonymous? That's cool. All fields are optional.</em>
  <fieldset class="col-lg-12">
    <div id="file_upload" class="col-lg-12">
      <%= f.file_field :url, accept: "*", id: 'direct-upload', class: "col-lg-12" %>
    </div>
  </fieldset>
  <div class="col-lg-12">
    <%= f.submit 'UPLOAD!', class: "col-lg-offset-4 col-lg-4 btn btn-primary" %>
  </div>
<% end %> 
</div>
<% @s3_direct_post = S3_BUCKET.presigned_post({ key: "uploads/#{SecureRandom.uuid}/${filename}", 
                                                acl: 'public-read', 
                                                success_action_status: '201', 
                                                metadata: { 'original-filename' => '${filename}' } }) %>
<script>
  $(function() {
    $('#<%= "upload_modal" %> #ugc_date').datetimepicker({
      format: 'MM/DD/YYYY'
    });
  });
</script>
<style>
  .bar {
    margin-top: .5em;
    height:  1.2em;
  }  
</style>

<script>  
  $(function() {
    var file_upload = $('#file_upload');
    var file_input = $('#direct-upload');  
    var form = $(file_input.parents('form:first'));
    var submit_button = form.find('input[type="submit"]');
    var progress_bar = $("<div class='bar'></div>");
    var pb_container = $("<div class='col-lg-12'></div>").append(progress_bar);
    file_upload.after(pb_container);
    console.log('init file upload');
    file_input.fileupload({
      maxFileSize: 1000000000,
      fileInput: file_input,
      url: '<%= @s3_direct_post.url %>',
      type: 'POST',
      autoUpload: true,
      formData: <%= @s3_direct_post.fields.to_json.html_safe %>,
      paramName: 'file',
      dataType: 'XML',
      replaceFileInput: false,
      progressall: function (e, data) {
        var progress = parseInt(data.loaded / data.total * 100, 10);
        progress_bar.css('width', progress + '%')
      },
      start: function (e) {
        console.log('called start');
        submit_button.prop('disabled', true);
        progress_bar.       
          css('background-repeat', 'no-repeat').
          css('background-image', 'linear-gradient(#88c149, #73a839 60%, #699934)').
          css('display', 'block').
          css('width', '0%').
          css('height', '20px')
          $('#upload_modal').modal({
            backdrop: 'static',
            keyboard: false
          });
          $('#close_button').prop('disabled', true);
      },
      done: function(e, data) {
        console.log('called finish');
        submit_button.prop('disabled', false);
        $('#upload_modal').modal({
          backdrop: true,
          keyboard: true
        });
        $('#close_button').prop('disabled', false);
        var key   = $(data.jqXHR.responseXML).find("Key").text();
        var url   = '//<%= URI(@s3_direct_post.url).host %>/' + key;
        var input = $("<input />", { type:'hidden', name: file_input.attr('name'), value: url })
        form.append(input);
      },
      fail: function(e, data) {
        console.log(e);
        console.log(data);
        submit_button.prop('disabled', false);
        $('#upload_modal').modal({
          backdrop: true,
          keyboard: true
        });
        $('#close_button').prop('disabled', false);
        progress_bar.
          css("background", "red")
      }
    });
  });
</script>
